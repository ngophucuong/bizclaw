<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BizClaw â€” Agent Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#08090d;--bg2:#0d1017;--surface:#12151e;--surface2:#1a1e2e;--border:#1e2433;--border-hover:#2a3048;
  --text:#e8ecf4;--text2:#7c8599;--accent:#6366f1;--accent2:#818cf8;--accent-glow:rgba(99,102,241,.12);
  --green:#34d399;--red:#ef4444;--orange:#fb923c;--blue:#60a5fa;--cyan:#22d3ee;--pink:#f472b6;
  --grad1:linear-gradient(135deg,#6366f1,#8b5cf6);
  --radius:10px;--font:'Inter',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.6}
a{color:var(--accent2);text-decoration:none}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Layout */
.app{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh}
.main{padding:28px 36px;overflow-y:auto;height:100vh}

/* Sidebar */
.logo{padding:20px;display:flex;align-items:center;gap:10px;font-size:17px;font-weight:700;border-bottom:1px solid var(--border)}
.logo .icon{font-size:22px}
.logo .text{background:var(--grad1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav{flex:1;padding:8px}
.nav a{display:flex;align-items:center;gap:10px;padding:9px 14px;border-radius:8px;color:var(--text2);font-size:13px;font-weight:500;transition:all .15s;cursor:pointer}
.nav a:hover{background:var(--surface2);color:var(--text)}
.nav a.active{background:var(--accent-glow);color:var(--accent2)}
.nav-sep{height:1px;background:var(--border);margin:8px 12px}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text2)}

/* Header */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.page-header h1{font-size:22px;font-weight:700}
.page-header .sub{font-size:13px;color:var(--text2)}

/* Cards & Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:28px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .2s}
.card:hover{border-color:var(--border-hover)}
.card-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;font-weight:600}
.card-value{font-size:26px;font-weight:700}
.card-sub{font-size:11px;color:var(--text2);margin-top:3px}

/* Colors */
.green{color:var(--green)}.red{color:var(--red)}.orange{color:var(--orange)}.blue{color:var(--blue)}.accent{color:var(--accent2)}.cyan{color:var(--cyan)}

/* Forms */
.form-section{margin-bottom:28px}
.form-section h2{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.form-row{display:grid;grid-template-columns:160px 1fr;align-items:center;gap:12px;padding:10px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.form-label{font-size:12px;color:var(--text2);font-weight:500}
.form-row input,.form-row select,.form-row textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text);font-size:13px;font-family:var(--font);outline:none;transition:border-color .2s}
.form-row input:focus,.form-row select:focus,.form-row textarea:focus{border-color:var(--accent)}
.form-row textarea{min-height:60px;resize:vertical;font-family:var(--mono);font-size:12px}

/* Buttons */
.btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;font-family:var(--font)}
.btn-primary{background:var(--grad1);color:#fff}
.btn-primary:hover{box-shadow:0 4px 16px rgba(99,102,241,.35);transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent2)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-green{background:#059669;color:#fff}.btn-green:hover{background:#047857}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{opacity:.9}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.badge-green{background:rgba(52,211,153,.12);color:var(--green)}
.badge-blue{background:rgba(96,165,250,.12);color:var(--blue)}
.badge-orange{background:rgba(251,146,60,.12);color:var(--orange)}
.badge-red{background:rgba(239,68,68,.12);color:var(--red)}
.badge-purple{background:rgba(99,102,241,.12);color:var(--accent2)}

/* Tables */
table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;padding:8px 12px;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
tr:hover td{background:rgba(255,255,255,.02)}

/* Chat */
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 120px)}
.chat-messages{flex:1;overflow-y:auto;padding:12px 0;display:flex;flex-direction:column;gap:10px}
.msg{max-width:72%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.55;animation:fadeIn .2s}
.msg-user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg-bot{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px;white-space:pre-wrap;font-family:var(--font)}
.msg-system{align-self:center;font-size:11px;color:var(--text2);font-style:italic}
.chat-input-wrap{display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border)}
.chat-input-wrap input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 16px;color:var(--text);font-size:13px;outline:none}
.chat-input-wrap input:focus{border-color:var(--accent)}
.chat-input-wrap button{background:var(--grad1);color:#fff;border:none;border-radius:8px;padding:11px 20px;font-size:13px;cursor:pointer;font-weight:600}
.typing{color:var(--text2);font-size:12px;padding:4px 0}

/* Channel cards */
.ch-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.ch-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .2s}
.ch-card:hover{border-color:var(--border-hover)}
.ch-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.ch-name{font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
.ch-fields{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.ch-fields label{font-size:11px;color:var(--text2);font-weight:500}
.ch-fields input,.ch-fields textarea{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-size:12px;outline:none;font-family:var(--mono)}
.ch-fields input:focus,.ch-fields textarea:focus{border-color:var(--accent)}
.ch-fields textarea{min-height:50px;resize:vertical}
.ch-actions{display:flex;gap:6px;flex-wrap:wrap}
.toggle{position:relative;width:36px;height:20px;display:inline-block}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:.2s}
.toggle .slider::before{content:'';position:absolute;width:16px;height:16px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:.2s}
.toggle input:checked + .slider{background:var(--accent)}
.toggle input:checked + .slider::before{transform:translateX(16px)}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-size:13px;z-index:999;animation:slideUp .3s;box-shadow:0 8px 32px rgba(0,0,0,.4)}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulse{animation:pulse 1.5s infinite}

/* Responsive */
@media(max-width:768px){.app{grid-template-columns:1fr}.sidebar{display:none}.main{padding:16px}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- Pairing Gate -->
<div id="pairing-gate" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:300;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:380px;text-align:center">
    <div style="font-size:32px;margin-bottom:12px">ğŸ”</div>
    <h2 style="color:var(--accent);margin-bottom:8px">BizClaw Agent</h2>
    <p style="color:var(--text2);font-size:13px;margin-bottom:24px">Nháº­p mÃ£ Pairing Code Ä‘á»ƒ truy cáº­p Dashboard</p>
    <div id="pairing-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
    <input id="pairing-input" type="text" placeholder="Pairing Code (6 digits)" maxlength="10" style="width:100%;padding:12px 16px;margin-bottom:14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:18px;text-align:center;letter-spacing:4px;font-family:var(--mono)" onkeydown="if(event.key==='Enter')doPairing()">
    <button style="width:100%;padding:12px;background:var(--grad1);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer" onclick="doPairing()">ğŸ”“ XÃ¡c nháº­n</button>
  </div>
</div>

<div id="app-container" class="app">
  <aside class="sidebar">
    <div class="logo"><span class="icon">âš¡</span><span class="text">BizClaw</span></div>
    <nav class="nav">
      <a href="/dashboard" onclick="navigateTo(event,'dashboard')" class="active" id="nav-dashboard">ğŸ“Š <span data-i18n="nav.dashboard">Báº£ng Ä‘iá»u khiá»ƒn</span></a>
      <a href="/chat" onclick="navigateTo(event,'chat')" id="nav-chat">ğŸ’¬ <span data-i18n="nav.webchat">TrÃ² chuyá»‡n</span></a>
      <div class="nav-sep"></div>
      <a href="/settings" onclick="navigateTo(event,'settings')" id="nav-settings">âš™ï¸ <span data-i18n="nav.settings">CÃ i Ä‘áº·t</span></a>
      <a href="/providers" onclick="navigateTo(event,'providers')" id="nav-providers">ğŸ”Œ <span data-i18n="nav.providers">NhÃ  cung cáº¥p</span></a>
      <a href="/channels" onclick="navigateTo(event,'channels')" id="nav-channels">ğŸ“± <span data-i18n="nav.channels">KÃªnh liÃªn láº¡c</span></a>
      <a href="/tools" onclick="navigateTo(event,'tools')" id="nav-tools">ğŸ› ï¸ <span data-i18n="nav.tools">CÃ´ng cá»¥</span></a>
      <div class="nav-sep"></div>
      <a href="/brain" onclick="navigateTo(event,'brain')" id="nav-brain">ğŸ§  <span data-i18n="nav.brain">Brain Engine</span></a>
      <a href="/configfile" onclick="navigateTo(event,'configfile')" id="nav-configfile">ğŸ“„ config.toml</a>
    </nav>
    <div class="sidebar-footer">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
        <button onclick="setLang('vi')" id="btn-vi" style="padding:2px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer">VI</button>
        <button onclick="setLang('en')" id="btn-en" style="padding:2px 8px;font-size:11px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer">EN</button>
      </div>
      <div id="ws-status">â¬œ <span data-i18n="status.disconnected">ÄÃ£ ngáº¯t káº¿t ná»‘i</span></div>
      <div style="margin-top:4px" id="agent-name">BizClaw Agent</div>
    </div>
  </aside>
  <main class="main">
    <!-- â•â•â• DASHBOARD (LobsterBoard-inspired) â•â•â• -->
    <div id="page-dashboard">
      <div class="page-header"><div><h1 data-i18n="dash.title">Báº£ng Ä‘iá»u khiá»ƒn</h1><div class="sub" data-i18n="dash.subtitle">Trung tÃ¢m quáº£n lÃ½ Agent Gateway</div></div></div>
      <!-- Widget Row 1: Quick Stats -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
        <div class="card" style="text-align:center">
          <div class="card-label">â° Clock</div>
          <div class="card-value accent" id="w-clock" style="font-size:22px;font-family:var(--mono)">--:--</div>
          <div class="card-sub" id="w-date">â€”</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.uptime">Uptime</div>
          <div class="card-value green" id="s-uptime" style="font-size:22px">â€”</div>
          <div class="card-sub" data-i18n="dash.status">Online</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.provider">Provider</div>
          <div class="card-value blue" id="s-provider" style="font-size:18px">â€”</div>
          <div class="card-sub" id="s-model" style="color:var(--cyan)">â€”</div>
        </div>
        <div class="card" style="text-align:center">
          <div class="card-label" data-i18n="dash.version">Version</div>
          <div class="card-value accent" id="s-version" style="font-size:18px">â€”</div>
          <div class="card-sub" id="s-platform" style="font-size:10px">â€”</div>
        </div>
      </div>
      <!-- Widget Row 2: System & Channels -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
        <!-- System Info Widget -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div class="card-label" style="margin:0">ğŸ–¥ï¸ System</div>
            <span class="badge badge-green" id="s-status">â— Online</span>
          </div>
          <div id="dash-system" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
            <div><span style="color:var(--text2)">OS:</span> <span id="sys-os">â€”</span></div>
            <div><span style="color:var(--text2)">Arch:</span> <span id="sys-arch">â€”</span></div>
            <div><span style="color:var(--text2)">SIMD:</span> <span id="brain-simd" style="color:var(--accent2)">â€”</span></div>
            <div><span style="color:var(--text2)">Memory:</span> <span id="sys-mem">â€”</span></div>
          </div>
        </div>
        <!-- Quick Actions Widget -->
        <div class="card">
          <div class="card-label" style="margin-bottom:10px">âš¡ Quick Actions</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'chat')">ğŸ’¬ Chat</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'settings')">âš™ï¸ Settings</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'channels')">ğŸ“± Channels</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'brain')">ğŸ§  Brain</button>
            <button class="btn btn-outline btn-sm" onclick="navigateTo(null,'configfile')">ğŸ“„ Config</button>
          </div>
        </div>
      </div>
      <!-- Widget Row 3: Channel Table -->
      <div class="card">
        <div class="card-label" style="margin-bottom:10px">ğŸ“¡ <span data-i18n="dash.channels">Active Channels</span></div>
        <table><thead><tr><th data-i18n="th.channel">KÃªnh</th><th data-i18n="th.type">Loáº¡i</th><th data-i18n="th.status">Tráº¡ng thÃ¡i</th><th data-i18n="th.configured">Config</th></tr></thead><tbody id="dash-channels"></tbody></table>
      </div>
    </div>

    <!-- â•â•â• WEBCHAT â•â•â• -->
    <div id="page-chat" style="display:none">
      <div class="page-header"><h1>ğŸ’¬ <span data-i18n="chat.title">TrÃ² chuyá»‡n</span></h1></div>
      <div class="chat-wrap">
        <div class="chat-messages" id="chat-messages">
          <div class="msg msg-system" data-i18n="chat.welcome">ÄÃ£ káº¿t ná»‘i BizClaw. Nháº­p tin nháº¯n Ä‘á»ƒ báº¯t Ä‘áº§u trÃ² chuyá»‡n.</div>
        </div>
        <div class="typing" id="chat-typing" style="display:none"><span data-i18n="chat.thinking">BizClaw Ä‘ang suy nghÄ©</span><span class="pulse">...</span></div>
        <div class="chat-input-wrap">
          <input type="text" id="chat-input" placeholder="Nháº­p tin nháº¯n..." data-i18n-placeholder="chat.placeholder" onkeydown="if(event.key==='Enter')sendChat()">
          <button onclick="sendChat()" data-i18n="chat.send">Gá»­i â†‘</button>
        </div>
      </div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div id="page-settings" style="display:none">
      <div class="page-header"><div><h1>âš™ï¸ Agent Settings</h1><div class="sub">Configure your AI agent â€” provider, model, identity, security</div></div>
        <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
      </div>
      <div class="form-section">
        <h2>ğŸ¤– AI Provider</h2>
        <div class="form-row"><span class="form-label">Provider</span><select id="set-provider" onchange="onProviderChange()">
          <option value="openai">OpenAI</option><option value="anthropic">Anthropic</option>
          <option value="gemini">Gemini</option><option value="deepseek">DeepSeek</option>
          <option value="groq">Groq</option><option value="ollama">Ollama (local)</option>
          <option value="llamacpp">llama.cpp</option><option value="brain">Brain Engine (offline)</option>
        </select></div>
        <!-- Cloud provider fields -->
        <div id="provider-cloud-fields">
          <div class="form-row"><span class="form-label">Model</span><input id="set-model" placeholder="gpt-4o-mini"></div>
          <div class="form-row"><span class="form-label">API Key</span><input id="set-apikey" type="password" placeholder="sk-..."></div>
        </div>
        <!-- Ollama fields -->
        <div id="provider-ollama-fields" style="display:none">
          <div class="form-row"><span class="form-label">Model</span><input id="set-ollama-model" placeholder="tinyllama, llama3.2, deepseek-r1:7b"></div>
          <div class="form-row"><span class="form-label">Ollama URL</span><input id="set-ollama-url" placeholder="http://localhost:11434"></div>
          <div class="form-row" style="background:var(--accent-glow);border-color:var(--accent)"><span class="form-label" style="color:var(--accent2)">ğŸ’¡ Tip</span><span style="font-size:12px;color:var(--text2)">Install: <code style="color:var(--cyan)">curl -fsSL https://ollama.ai/install.sh | sh</code> then <code style="color:var(--cyan)">ollama pull tinyllama</code></span></div>
        </div>
        <!-- Brain Engine fields -->
        <div id="provider-brain-fields" style="display:none">
          <div class="form-row"><span class="form-label">Model Path</span><input id="set-brain-path" placeholder="~/.bizclaw/models/tinyllama.gguf"></div>
          <div class="form-row"><span class="form-label">Threads</span><input id="set-brain-threads" type="number" min="1" max="32" value="4" placeholder="4"></div>
          <div class="form-row" style="background:var(--accent-glow);border-color:var(--accent)"><span class="form-label" style="color:var(--accent2)">ğŸ§  Brain</span><span style="font-size:12px;color:var(--text2)">GGUF models run 100% offline. Download: <code style="color:var(--cyan)">bizclaw brain download tinyllama-1.1b</code></span></div>
        </div>
        <!-- llama.cpp fields -->
        <div id="provider-llamacpp-fields" style="display:none">
          <div class="form-row"><span class="form-label">Server URL</span><input id="set-llamacpp-url" placeholder="http://localhost:8080"></div>
          <div class="form-row"><span class="form-label">Model</span><input id="set-llamacpp-model" placeholder="(auto-detected)"></div>
        </div>
        <div class="form-row"><span class="form-label">Temperature</span><input id="set-temp" type="number" step="0.1" min="0" max="2" value="0.7"></div>
      </div>
      <div class="form-section">
        <h2>ğŸ­ Identity</h2>
        <div class="form-row"><span class="form-label">Agent Name</span><input id="set-name" placeholder="BizClaw"></div>
        <div class="form-row"><span class="form-label">Persona</span><input id="set-persona" placeholder="A helpful AI assistant"></div>
        <div class="form-row"><span class="form-label">System Prompt</span><textarea id="set-sysprompt" placeholder="You are BizClaw, a fast and capable AI assistant."></textarea></div>
      </div>
      <div class="form-section">
        <h2>ğŸ’¾ Memory</h2>
        <div class="form-row"><span class="form-label">Backend</span><select id="set-mem-backend"><option value="sqlite">SQLite</option><option value="postgres">PostgreSQL</option><option value="none">None (NoOp)</option></select></div>
        <div class="form-row"><span class="form-label">Auto Save</span><select id="set-mem-autosave"><option value="true">Yes</option><option value="false">No</option></select></div>
      </div>
      <div class="form-section">
        <h2>ğŸ”’ Security / Autonomy</h2>
        <div class="form-row"><span class="form-label">Autonomy Level</span><select id="set-auto-level"><option value="readonly">Read Only</option><option value="supervised">Supervised</option><option value="full">Full</option></select></div>
        <div class="form-row"><span class="form-label">Workspace Only</span><select id="set-auto-workspace"><option value="true">Yes</option><option value="false">No</option></select></div>
      </div>
    </div>

    <!-- â•â•â• PROVIDERS â•â•â• -->
    <div id="page-providers" style="display:none">
      <div class="page-header"><h1>ğŸ”Œ Providers</h1></div>
      <div class="card"><table><thead><tr><th>Provider</th><th>Type</th><th>Status</th><th>Models</th></tr></thead><tbody id="providers-table"></tbody></table></div>
    </div>

    <!-- â•â•â• CHANNELS â•â•â• -->
    <div id="page-channels" style="display:none">
      <div class="page-header"><div><h1>ğŸ“± Channel Configuration</h1><div class="sub">Connect your agent to messaging platforms</div></div></div>
      <div class="ch-grid" id="channels-grid"></div>
      <!-- Zalo QR Modal -->
      <div id="zalo-qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:420px;width:90%;text-align:center">
          <h2 style="margin-bottom:12px">ğŸ“± Zalo QR Login</h2>
          <div id="zalo-qr-content" style="margin:16px 0;min-height:100px"><div class="pulse" style="color:var(--text2)">Äang táº¡o mÃ£ QR...</div></div>
          <div id="zalo-qr-instructions" style="font-size:12px;color:var(--text2);text-align:left;margin:12px 0"></div>
          <div id="zalo-qr-imei" style="font-size:11px;color:var(--text2);margin:8px 0"></div>
          <button class="btn btn-outline" onclick="closeZaloQR()" style="margin-top:12px">ÄÃ³ng</button>
        </div>
      </div>
    </div>

    <!-- â•â•â• TOOLS â•â•â• -->
    <div id="page-tools" style="display:none">
      <div class="page-header"><h1>ğŸ› ï¸ Tools</h1></div>
      <div class="stats">
        <div class="card"><div class="card-label">Shell</div><div class="card-value green">â— Active</div><div class="card-sub">Execute system commands (sandboxed)</div></div>
        <div class="card"><div class="card-label">File</div><div class="card-value green">â— Active</div><div class="card-sub">Read/write/list files</div></div>
        <div class="card"><div class="card-label">Web Search</div><div class="card-value green">â— Active</div><div class="card-sub">DuckDuckGo search</div></div>
        <div class="card"><div class="card-label">Calendar</div><div class="card-value orange">â— Available</div><div class="card-sub">Google Calendar integration</div></div>
        <div class="card"><div class="card-label">Document Reader</div><div class="card-value green">â— Active</div><div class="card-sub">PDF, DOCX, Excel, CSV extraction</div></div>
        <div class="card"><div class="card-label">Group Summarizer</div><div class="card-value green">â— Active</div><div class="card-sub">Zalo/Telegram group message summary</div></div>
      </div>
    </div>

    <!-- â•â•â• BRAIN ENGINE â•â•â• -->
    <div id="page-brain" style="display:none">
      <div class="page-header"><h1>ğŸ§  Brain Engine</h1></div>
      <div class="stats">
        <div class="card"><div class="card-label">Engine</div><div class="card-value green">GGUF v3</div></div>
        <div class="card"><div class="card-label">SIMD</div><div class="card-value accent" id="brain-simd">â€”</div></div>
        <div class="card"><div class="card-label">Quantization</div><div class="card-value blue">Q4_0 / Q8_0 / F16</div></div>
        <div class="card"><div class="card-label">Features</div><div class="card-value cyan">Flash Attn + KV Cache</div></div>
      </div>
      <div class="form-section"><h2>Available Models</h2>
        <div class="card"><table><thead><tr><th>Model</th><th>Size</th><th>Download</th></tr></thead><tbody>
          <tr><td><strong>TinyLlama 1.1B</strong></td><td>~638 MB</td><td><code>bizclaw brain download tinyllama-1.1b</code></td></tr>
          <tr><td><strong>Phi-2</strong></td><td>~1.6 GB</td><td><code>bizclaw brain download phi-2</code></td></tr>
          <tr><td><strong>Llama 3.2 1B</strong></td><td>~750 MB</td><td><code>bizclaw brain download llama-3.2-1b</code></td></tr>
          <tr><td><strong>Qwen 3 0.6B</strong></td><td>~400 MB</td><td><code>bizclaw brain download qwen3-0.6b</code></td></tr>
        </tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• CONFIG FILE â•â•â• -->
    <div id="page-configfile" style="display:none">
      <div class="page-header"><div><h1>ğŸ“„ config.toml</h1><div class="sub" id="config-path">â€”</div></div></div>
      <div class="card"><pre id="config-toml-content" style="font-family:var(--mono);font-size:12px;line-height:1.7;color:var(--accent2);white-space:pre-wrap;max-height:70vh;overflow-y:auto;padding:4px">Loading...</pre></div>
    </div>
  </main>
</div>

<script>
const API = '';
let ws = null, configData = {};
let pairingCode = sessionStorage.getItem('bizclaw_pairing')||'';

// â•â•â• AUTH â•â•â•
function authHeaders(extra={}){
  return {...extra,'X-Pairing-Code':pairingCode,'Content-Type':'application/json'};
}
async function authFetch(url,opts={}){
  if(!opts.headers) opts.headers={};
  opts.headers['X-Pairing-Code']=pairingCode;
  const res=await fetch(url,opts);
  if(res.status===401){sessionStorage.removeItem('bizclaw_pairing');pairingCode='';showPairingGate();throw new Error('Invalid pairing code');}
  return res;
}
function showPairingGate(){
  document.getElementById('pairing-gate').style.display='flex';
  document.getElementById('app-container').style.display='none';
}
function hidePairingGate(){
  document.getElementById('pairing-gate').style.display='none';
  document.getElementById('app-container').style.display='grid';
}
async function doPairing(){
  const code=document.getElementById('pairing-input').value.trim();
  const errEl=document.getElementById('pairing-error');
  errEl.style.display='none';
  if(!code){errEl.textContent='Vui l\xf2ng nh\u1eadp m\xe3 pairing';errEl.style.display='block';return;}
  try{
    const res=await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});
    const r=await res.json();
    if(r.ok){pairingCode=code;sessionStorage.setItem('bizclaw_pairing',code);hidePairingGate();initApp();}
    else{errEl.textContent=r.error||'Sai m\xe3 pairing';errEl.style.display='block';}
  }catch(e){errEl.textContent=e.message;errEl.style.display='block';}
}
async function checkPairing(){
  // First check if pairing is required at all
  try{
    const res=await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:''})});
    const r=await res.json();
    if(r.ok){hidePairingGate();initApp();return;} // no pairing required
  }catch(e){}
  if(pairingCode){
    try{const r=await(await fetch('/api/v1/verify-pairing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code:pairingCode})})).json();
      if(r.ok){hidePairingGate();initApp();return;}
    }catch(e){}
  }
  showPairingGate();
}

// â•â•â• NAVIGATION (Path Router â€” History API) â•â•â•
function navigateTo(event, name) {
  if (event) event.preventDefault();
  showPage(name, true);
}

function showPage(name, pushState) {
  // Update URL path using History API
  const targetPath = '/' + (name === 'dashboard' ? '' : name);
  if (pushState !== false && location.pathname !== targetPath && !(name === 'dashboard' && location.pathname === '/')) {
    history.pushState({ page: name }, '', targetPath);
  }
  document.querySelectorAll('[id^=page-]').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  const nav = document.getElementById('nav-' + name);
  if (page) page.style.display = '';
  if (nav) nav.classList.add('active');
  if (name === 'chat') document.getElementById('chat-input').focus();
  if (name === 'settings') loadSettingsForm();
  if (name === 'channels') renderChannelCards();
  if (name === 'configfile') loadConfigToml();
}

// Handle browser back/forward
window.addEventListener('popstate', (ev) => {
  const name = getPageFromPath();
  showPage(name, false);
});

// Get page name from current URL pathname
function getPageFromPath() {
  const path = location.pathname.replace(/^\//, '').replace(/\/$/, '');
  // Map valid page names
  const validPages = ['dashboard','chat','settings','providers','channels','tools','brain','configfile'];
  if (!path || path === '' || !validPages.includes(path)) return 'dashboard';
  return path;
}

// Route from current path on load
function routeFromPath() {
  const name = getPageFromPath();
  showPage(name, false);
}

// â•â•â• DASHBOARD (widget-based) â•â•â•
function updateClock() {
  const now = new Date();
  const el = document.getElementById('w-clock');
  const dt = document.getElementById('w-date');
  if(el) el.textContent = now.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(dt) dt.textContent = now.toLocaleDateString(currentLang==='vi'?'vi-VN':'en-US',{weekday:'short',month:'short',day:'numeric'});
}
setInterval(updateClock, 1000);

async function loadDashboard() {
  updateClock();
  try {
    const info = await (await authFetch(API + '/api/v1/info')).json();
    document.getElementById('s-version').textContent = 'v' + (info.version||'?');
    document.getElementById('s-provider').textContent = info.default_provider || 'â€”';
    document.getElementById('s-model').textContent = info.default_model || 'â€”';
    document.getElementById('s-uptime').textContent = fmtUptime(info.uptime_secs);
    document.getElementById('s-platform').textContent = info.platform || 'â€”';
    document.getElementById('agent-name').textContent = (info.name || 'BizClaw') + ' Agent';
    const arch = info.platform || '';
    document.getElementById('brain-simd').textContent = arch.includes('aarch64') ? 'NEON' : arch.includes('x86') ? 'AVX2/SSE2' : 'Auto';
    // Parse system info
    const parts = arch.split('-');
    const sysOs = document.getElementById('sys-os');
    const sysArch = document.getElementById('sys-arch');
    if(sysOs) sysOs.textContent = parts.length >= 2 ? parts.slice(1).join('-') : arch;
    if(sysArch) sysArch.textContent = parts[0] || 'â€”';
  } catch(e) {}
  try {
    const ch = await (await authFetch(API + '/api/v1/channels')).json();
    document.getElementById('dash-channels').innerHTML = ch.channels.map(c => `<tr>
      <td><strong>${c.name}</strong></td><td>${c.type}</td>
      <td><span class="badge badge-${c.status==='active'?'green':c.status==='disabled'?'orange':'blue'}">${c.status}</span></td>
      <td>${c.configured?'âœ…':'â€”'}</td>
    </tr>`).join('');
  } catch(e) {}
}

async function loadProviders() {
  try {
    const data = await (await authFetch(API + '/api/v1/providers')).json();
    document.getElementById('providers-table').innerHTML = data.providers.map(p => `<tr>
      <td><strong>${p.name}</strong></td><td>${p.type}</td>
      <td><span class="badge badge-${p.status==='active'?'green':'blue'}">${p.status}</span></td>
      <td style="font-size:12px;color:var(--text2)">${(p.models||[]).join(', ')}</td>
    </tr>`).join('');
  } catch(e) {}
}

// â•â•â• SETTINGS â•â•â•
async function loadConfig() {
  try {
    configData = await (await authFetch(API + '/api/v1/config')).json();
  } catch(e) { configData = {}; }
}

// Provider-specific form visibility
function onProviderChange() {
  const provider = document.getElementById('set-provider').value;
  // Hide all provider-specific sections
  ['cloud','ollama','brain','llamacpp'].forEach(id => {
    const el = document.getElementById('provider-'+id+'-fields');
    if(el) el.style.display = 'none';
  });
  // Show the relevant one
  if (provider === 'brain') {
    document.getElementById('provider-brain-fields').style.display = '';
  } else if (provider === 'ollama') {
    document.getElementById('provider-ollama-fields').style.display = '';
  } else if (provider === 'llamacpp') {
    document.getElementById('provider-llamacpp-fields').style.display = '';
  } else {
    document.getElementById('provider-cloud-fields').style.display = '';
  }
}

function loadSettingsForm() {
  const c = configData;
  if (!c.default_provider) return;
  const provider = c.default_provider || 'openai';
  document.getElementById('set-provider').value = provider;
  document.getElementById('set-temp').value = c.default_temperature || 0.7;
  // Fill model & API key for cloud providers
  document.getElementById('set-model').value = c.default_model || '';
  document.getElementById('set-apikey').value = c.api_key_set ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
  // Fill Ollama fields
  document.getElementById('set-ollama-model').value = (provider === 'ollama' ? c.default_model : '') || '';
  // Fill Brain fields
  const brain = c.brain || {};
  document.getElementById('set-brain-path').value = brain.model_path || '';
  document.getElementById('set-brain-threads').value = brain.threads || 4;
  // Toggle visibility
  onProviderChange();
  // Identity
  const id = c.identity || {};
  document.getElementById('set-name').value = id.name || '';
  document.getElementById('set-persona').value = id.persona || '';
  document.getElementById('set-sysprompt').value = id.system_prompt || '';
  // Memory
  const mem = c.memory || {};
  document.getElementById('set-mem-backend').value = mem.backend || 'sqlite';
  document.getElementById('set-mem-autosave').value = String(mem.auto_save !== false);
  // Autonomy
  const auto = c.autonomy || {};
  document.getElementById('set-auto-level').value = auto.level || 'supervised';
  document.getElementById('set-auto-workspace').value = String(auto.workspace_only !== false);
}

async function saveSettings() {
  const provider = document.getElementById('set-provider').value;
  let modelVal = '';
  if (provider === 'brain') {
    modelVal = 'brain-local';
  } else if (provider === 'ollama') {
    modelVal = document.getElementById('set-ollama-model').value;
  } else if (provider === 'llamacpp') {
    modelVal = document.getElementById('set-llamacpp-model').value;
  } else {
    modelVal = document.getElementById('set-model').value;
  }
  const body = {
    default_provider: provider,
    default_model: modelVal,
    default_temperature: parseFloat(document.getElementById('set-temp').value),
    identity: {
      name: document.getElementById('set-name').value,
      persona: document.getElementById('set-persona').value,
      system_prompt: document.getElementById('set-sysprompt').value,
    },
    memory: {
      backend: document.getElementById('set-mem-backend').value,
      auto_save: document.getElementById('set-mem-autosave').value === 'true',
    },
    autonomy: {
      level: document.getElementById('set-auto-level').value,
      workspace_only: document.getElementById('set-auto-workspace').value === 'true',
    },
  };
  // Provider-specific fields
  if (provider === 'brain') {
    body.brain = {
      enabled: true,
      model_path: document.getElementById('set-brain-path').value,
      threads: parseInt(document.getElementById('set-brain-threads').value) || 4,
    };
  }
  const apiKeyVal = document.getElementById('set-apikey').value;
  if (apiKeyVal && !apiKeyVal.startsWith('â€¢') && !['brain','ollama','llamacpp'].includes(provider)) {
    body.api_key = apiKeyVal;
  }
  try {
    const res = await authFetch(API + '/api/v1/config/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    toast(r.ok ? 'âœ… Settings saved!' : 'âŒ ' + r.error);
    if (r.ok) { await loadConfig(); loadDashboard(); }
  } catch(e) { toast('âŒ ' + e.message); }
}

// â•â•â• CHANNELS â•â•â•
const CHANNELS = [
  {type:'telegram',name:'Telegram Bot',icon:'ğŸ¤–',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'123456:ABC-DEF...'},
    {key:'allowed_chat_ids',label:'Allowed Chat IDs',type:'text',placeholder:'123456789, -100123...'},
  ]},
  {type:'zalo',name:'Zalo Personal',icon:'ğŸ’¬',hasQR:true,fields:[
    {key:'cookie',label:'Zalo Cookie',type:'textarea',placeholder:'Paste cookie tá»« chat.zalo.me â†’ F12 â†’ Application â†’ Cookies'},
    {key:'imei',label:'IMEI',type:'text',placeholder:'Tá»± Ä‘á»™ng táº¡o náº¿u Ä‘á»ƒ trá»‘ng'},
  ]},
  {type:'discord',name:'Discord Bot',icon:'ğŸ®',fields:[
    {key:'bot_token',label:'Bot Token',type:'password',placeholder:'MTk...'},
    {key:'allowed_channel_ids',label:'Channel IDs',type:'text',placeholder:'123456789, 987654321'},
  ]},
  {type:'email',name:'Email (SMTP)',icon:'ğŸ“§',fields:[
    {key:'smtp_host',label:'SMTP Host',type:'text',placeholder:'smtp.gmail.com'},
    {key:'smtp_port',label:'Port',type:'text',placeholder:'587'},
    {key:'smtp_user',label:'Username',type:'text',placeholder:'agent@company.com'},
    {key:'smtp_pass',label:'Password',type:'password',placeholder:'App password'},
  ]},
  {type:'whatsapp',name:'WhatsApp Business',icon:'ğŸ“²',fields:[
    {key:'phone_id',label:'Phone Number ID',type:'text',placeholder:'Cloud API Phone ID'},
    {key:'access_token',label:'Access Token',type:'password',placeholder:'EAAG...'},
    {key:'webhook_secret',label:'Webhook Verify Token',type:'text',placeholder:'my_verify_token'},
  ]},
  {type:'webhook',name:'Webhook API',icon:'ğŸ”—',fields:[
    {key:'webhook_url',label:'Inbound URL',type:'text',placeholder:'https://your-app.com/webhook'},
    {key:'webhook_secret',label:'Secret',type:'password',placeholder:'shared secret for HMAC'},
  ]},
];

function renderChannelCards() {
  const ch = configData.channels || {};
  document.getElementById('channels-grid').innerHTML = CHANNELS.map(def => {
    const saved = ch[def.type];
    const enabled = saved && saved.enabled !== undefined ? saved.enabled : false;
    return `<div class="ch-card">
      <div class="ch-header">
        <span class="ch-name">${def.icon} ${def.name}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge badge-${enabled?'green':'orange'}">${enabled?'Active':'Disabled'}</span>
          <label class="toggle"><input type="checkbox" id="ch-toggle-${def.type}" ${enabled?'checked':''}><span class="slider"></span></label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          const val = (saved && saved[f.key]) || '';
          if (f.type === 'textarea') return `<label>${f.label}</label><textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${val}</textarea>`;
          return `<label>${f.label}</label><input type="${f.type}" id="ch-${def.type}-${f.key}" value="${val}" placeholder="${f.placeholder}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">ğŸ’¾ Save</button>
        ${def.hasQR ? '<button class="btn btn-green btn-sm" onclick="openZaloQR()">ğŸ“± QuÃ©t mÃ£ QR</button>' : ''}
      </div>
    </div>`;
  }).join('');
}

async function saveChannel(type) {
  const def = CHANNELS.find(c => c.type === type);
  if (!def) return;
  const body = {
    channel_type: type,
    enabled: document.getElementById('ch-toggle-' + type)?.checked || false,
  };
  def.fields.forEach(f => {
    const el = document.getElementById('ch-' + type + '-' + f.key);
    if (el) body[f.key] = el.value;
  });
  try {
    const res = await authFetch(API + '/api/v1/channels/update', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const r = await res.json();
    toast(r.ok ? `âœ… ${type} config saved` : 'âŒ ' + r.error);
    if (r.ok) { await loadConfig(); renderChannelCards(); }
  } catch(e) { toast('âŒ ' + e.message); }
}

async function openZaloQR() {
  const modal = document.getElementById('zalo-qr-modal');
  modal.style.display = 'flex';
  document.getElementById('zalo-qr-content').innerHTML = '<div class="pulse" style="color:var(--text2)">Äang káº¿t ná»‘i Ä‘áº¿n Zalo...</div>';
  try {
    const res = await authFetch(API + '/api/v1/zalo/qr', {method:'POST',headers:{'Content-Type':'application/json'}});
    const r = await res.json();
    if (r.ok) {
      document.getElementById('zalo-qr-content').innerHTML = r.qr_code.startsWith('data:') 
        ? `<img src="${r.qr_code}" style="max-width:280px;border-radius:12px;border:2px solid var(--accent)">`
        : `<div style="background:#fff;padding:16px;border-radius:12px;display:inline-block"><div style="font-family:var(--mono);font-size:11px;word-break:break-all;color:#333;max-width:260px">${r.qr_code}</div></div>`;
      document.getElementById('zalo-qr-instructions').innerHTML = (r.instructions||[]).map(i => `<div style="margin:3px 0">${i}</div>`).join('');
      document.getElementById('zalo-qr-imei').textContent = r.imei ? `IMEI: ${r.imei}` : '';
      // Auto-fill IMEI into channel card
      const imeiEl = document.getElementById('ch-zalo-imei');
      if (imeiEl && r.imei) imeiEl.value = r.imei;
    } else {
      document.getElementById('zalo-qr-content').innerHTML = `<div style="color:var(--red)">âŒ ${r.error}</div><div style="margin-top:12px;font-size:12px;color:var(--text2)">${r.fallback||''}</div>`;
    }
  } catch(e) {
    document.getElementById('zalo-qr-content').innerHTML = `<div style="color:var(--red)">Lá»—i káº¿t ná»‘i: ${e.message}</div>`;
  }
}

function closeZaloQR() {
  document.getElementById('zalo-qr-modal').style.display = 'none';
}

// â•â•â• CONFIG TOML â•â•â•
async function loadConfigToml() {
  try {
    const data = await (await authFetch(API + '/api/v1/config/full')).json();
    document.getElementById('config-toml-content').textContent = data.toml || 'No config loaded';
    document.getElementById('config-path').textContent = data.config_path || '';
  } catch(e) {}
}

// â•â•â• WEBSOCKET CHAT â•â•â•
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  // Include pairing code in query param (WS doesn't support custom headers)
  const codeParam = pairingCode ? '?code=' + encodeURIComponent(pairingCode) : '';
  ws = new WebSocket(proto + '//' + location.host + '/ws' + codeParam);
  ws.onopen = () => {
    document.getElementById('ws-status').innerHTML = 'ğŸŸ¢ ' + t('status.connected');
    // Send ping every 25s to keep alive
    if(window._wsPing) clearInterval(window._wsPing);
    window._wsPing = setInterval(() => { if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:'ping'})); }, 25000);
  };
  ws.onclose = (ev) => {
    document.getElementById('ws-status').innerHTML = 'ğŸ”´ ' + t('status.disconnected');
    if(window._wsPing) clearInterval(window._wsPing);
    setTimeout(connectWS, 3000);
  };
  ws.onerror = (ev) => {
    console.error('WS error:', ev);
  };
  ws.onmessage = (e) => {
    try { handleWS(JSON.parse(e.data)); } catch(err) { console.error('WS parse error:', err, e.data); }
  };
}

function handleWS(msg) {
  const el = document.getElementById('chat-messages');
  const typing = document.getElementById('chat-typing');
  switch(msg.type) {
    case 'connected':
      addMsg(`Connected â€” ${msg.provider}/${msg.model}`, 'system');
      break;
    case 'chat_start': typing.style.display = ''; break;
    case 'chat_chunk':
      typing.style.display = 'none';
      let s = el.querySelector('.msg-streaming');
      if (!s) { s = document.createElement('div'); s.className = 'msg msg-bot msg-streaming'; el.appendChild(s); }
      s.textContent += msg.content;
      el.scrollTop = el.scrollHeight;
      break;
    case 'chat_done':
      typing.style.display = 'none';
      const st = el.querySelector('.msg-streaming');
      if (st) st.classList.remove('msg-streaming');
      break;
    case 'chat_response': addMsg(msg.content, 'bot'); break;
    case 'chat_error': addMsg('âŒ ' + (msg.error||'Unknown error'), 'system'); typing.style.display = 'none'; break;
    case 'status':
      addMsg(`ğŸ“Š Provider: ${msg.provider} | Model: ${msg.model} | Uptime: ${fmtUptime(msg.uptime_secs)} | Requests: ${msg.requests_processed}`, 'system');
      break;
    case 'pong': break; // silent
    case 'error': addMsg('âš ï¸ ' + msg.message, 'system'); break;
  }
}

function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== 1) return;
  input.value = '';

  // Slash commands
  if (text === '/status') {
    ws.send(JSON.stringify({type:'status'}));
    addMsg('/status', 'user');
    return;
  }
  if (text === '/reset') {
    document.getElementById('chat-messages').innerHTML = '<div class="msg msg-system">' + t('chat.history_cleared') + '</div>';
    return;
  }
  if (text === '/help') {
    addMsg('/help', 'user');
    addMsg(t('chat.help'), 'system');
    return;
  }

  addMsg(text, 'user');
  ws.send(JSON.stringify({type:'chat',content:text,stream:true}));
}

function addMsg(text, role) {
  const el = document.createElement('div');
  el.className = 'msg msg-' + role;
  el.textContent = text;
  document.getElementById('chat-messages').appendChild(el);
  el.parentElement.scrollTop = el.parentElement.scrollHeight;
}

// â•â•â• HELPERS â•â•â•
function fmtUptime(s) {
  if (!s) return 'â€”';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
  return h + 'h ' + m + 'm';
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// â•â•â• i18n â•â•â•
let currentLang = localStorage.getItem('bizclaw_lang') || 'vi';
const I18N = {
  vi: {
    'nav.dashboard':'Báº£ng Ä‘iá»u khiá»ƒn','nav.webchat':'TrÃ² chuyá»‡n','nav.settings':'CÃ i Ä‘áº·t',
    'nav.providers':'NhÃ  cung cáº¥p','nav.channels':'KÃªnh liÃªn láº¡c','nav.tools':'CÃ´ng cá»¥',
    'nav.brain':'Brain Engine',
    'dash.title':'Báº£ng Ä‘iá»u khiá»ƒn','dash.subtitle':'Trung tÃ¢m quáº£n lÃ½ Agent Gateway',
    'dash.status':'Tráº¡ng thÃ¡i','dash.version':'PhiÃªn báº£n','dash.provider':'NhÃ  cung cáº¥p',
    'dash.model':'MÃ´ hÃ¬nh AI','dash.uptime':'Thá»i gian hoáº¡t Ä‘á»™ng','dash.platform':'Ná»n táº£ng',
    'dash.channels':'KÃªnh Ä‘ang hoáº¡t Ä‘á»™ng',
    'th.channel':'KÃªnh','th.type':'Loáº¡i','th.status':'Tráº¡ng thÃ¡i','th.configured':'ÄÃ£ cáº¥u hÃ¬nh',
    'chat.title':'TrÃ² chuyá»‡n','chat.welcome':'ÄÃ£ káº¿t ná»‘i BizClaw. Nháº­p tin nháº¯n Ä‘á»ƒ báº¯t Ä‘áº§u trÃ² chuyá»‡n.',
    'chat.thinking':'BizClaw Ä‘ang suy nghÄ©','chat.placeholder':'Nháº­p tin nháº¯n...','chat.send':'Gá»­i â†‘',
    'chat.history_cleared':'ğŸ’¬ ÄÃ£ xÃ³a lá»‹ch sá»­ trÃ² chuyá»‡n',
    'chat.help':'Lá»‡nh cÃ³ sáºµn:\n/status â€” Xem tráº¡ng thÃ¡i agent\n/reset â€” XÃ³a lá»‹ch sá»­ chat\n/help â€” Hiá»‡n trá»£ giÃºp',
    'status.connected':'ÄÃ£ káº¿t ná»‘i','status.disconnected':'ÄÃ£ ngáº¯t káº¿t ná»‘i',
    'settings.title':'CÃ i Ä‘áº·t Agent','settings.subtitle':'Cáº¥u hÃ¬nh AI agent â€” nhÃ  cung cáº¥p, mÃ´ hÃ¬nh, danh tÃ­nh, báº£o máº­t',
    'settings.save':'ğŸ’¾ LÆ°u cÃ i Ä‘áº·t',
    'brain.title':'Brain Engine','tools.title':'CÃ´ng cá»¥','providers.title':'NhÃ  cung cáº¥p',
    'channels.title':'Cáº¥u hÃ¬nh kÃªnh liÃªn láº¡c','channels.subtitle':'Káº¿t ná»‘i agent vá»›i cÃ¡c ná»n táº£ng nháº¯n tin',
    'config.title':'config.toml',
    'pairing.title':'BizClaw Agent','pairing.desc':'Nháº­p mÃ£ Pairing Code Ä‘á»ƒ truy cáº­p Dashboard',
    'pairing.confirm':'ğŸ”“ XÃ¡c nháº­n','pairing.error':'Vui lÃ²ng nháº­p mÃ£ pairing',
  },
  en: {
    'nav.dashboard':'Dashboard','nav.webchat':'WebChat','nav.settings':'Settings',
    'nav.providers':'Providers','nav.channels':'Channels','nav.tools':'Tools',
    'nav.brain':'Brain Engine',
    'dash.title':'Dashboard','dash.subtitle':'Agent Gateway Control Panel',
    'dash.status':'Status','dash.version':'Version','dash.provider':'Provider',
    'dash.model':'AI Model','dash.uptime':'Uptime','dash.platform':'Platform',
    'dash.channels':'Active Channels',
    'th.channel':'Channel','th.type':'Type','th.status':'Status','th.configured':'Configured',
    'chat.title':'WebChat','chat.welcome':'Connected to BizClaw. Type a message to start chatting.',
    'chat.thinking':'BizClaw is thinking','chat.placeholder':'Type your message...','chat.send':'Send â†‘',
    'chat.history_cleared':'ğŸ’¬ Chat history cleared',
    'chat.help':'Available commands:\n/status â€” Show agent status\n/reset â€” Clear chat history\n/help â€” Show this help',
    'status.connected':'Connected','status.disconnected':'Disconnected',
    'settings.title':'Agent Settings','settings.subtitle':'Configure your AI agent â€” provider, model, identity, security',
    'settings.save':'ğŸ’¾ Save Settings',
    'brain.title':'Brain Engine','tools.title':'Tools','providers.title':'Providers',
    'channels.title':'Channel Configuration','channels.subtitle':'Connect your agent to messaging platforms',
    'config.title':'config.toml',
    'pairing.title':'BizClaw Agent','pairing.desc':'Enter Pairing Code to access Dashboard',
    'pairing.confirm':'ğŸ”“ Confirm','pairing.error':'Please enter pairing code',
  }
};
function t(key){ return (I18N[currentLang]||I18N.vi)[key] || (I18N.vi[key]) || key; }
function setLang(lang){
  currentLang = lang;
  localStorage.setItem('bizclaw_lang', lang);
  document.getElementById('btn-vi').style.background = lang==='vi' ? 'var(--accent)' : 'transparent';
  document.getElementById('btn-vi').style.color = lang==='vi' ? '#fff' : 'var(--text2)';
  document.getElementById('btn-en').style.background = lang==='en' ? 'var(--accent)' : 'transparent';
  document.getElementById('btn-en').style.color = lang==='en' ? '#fff' : 'var(--text2)';
  // Update all data-i18n elements
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
  // Update WS status
  if(ws && ws.readyState === 1) {
    document.getElementById('ws-status').innerHTML = 'ğŸŸ¢ ' + t('status.connected');
  } else {
    document.getElementById('ws-status').innerHTML = 'ğŸ”´ ' + t('status.disconnected');
  }
}

// â•â•â• INIT â•â•â•
async function initApp(){
  setLang(currentLang);
  routeFromPath();
  await loadConfig();
  loadDashboard();
  loadProviders();
  connectWS();
  setInterval(loadDashboard, 15000);
}
checkPairing();
</script>
</body>
</html>
